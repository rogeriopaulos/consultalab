{% extends "allauth/layouts/entrance.html" %}

{% load i18n %}
{% load allauth account %}

{% block head_title %}
  {% trans "Verificação em Duas Etapas" %}
{% endblock head_title %}
{% block content %}
  <div class="card-header">
    <h2 class="card-title">
      <i class="bi bi-shield-lock me-2"></i>
      Verificação em Duas Etapas
    </h2>
    <p class="card-description">
      Digite o código de 6 dígitos do seu aplicativo autenticador ou use um código de recuperação.
    </p>
  </div>
  <div class="card-content">
    {% url 'mfa_authenticate' as action_url %}
    {% element form form=form method="post" action=action_url %}
    {% slot body %}
    {% csrf_token %}
    <!-- Abas para escolher tipo de código -->
    <ul class="nav nav-tabs nav-justified mb-3" id="mfaTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active"
                id="totp-tab"
                data-bs-toggle="tab"
                data-bs-target="#totp"
                type="button"
                role="tab"
                aria-controls="totp"
                aria-selected="true">
          <i class="bi bi-smartphone me-1"></i>
          Aplicativo
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="recovery-tab"
                data-bs-toggle="tab"
                data-bs-target="#recovery"
                type="button"
                role="tab"
                aria-controls="recovery"
                aria-selected="false">
          <i class="bi bi-key me-1"></i>
          Código de Recuperação
        </button>
      </li>
    </ul>
    <div class="tab-content" id="mfaTabContent">
      <!-- Tab do código TOTP -->
      <div class="tab-pane fade show active"
           id="totp"
           role="tabpanel"
           aria-labelledby="totp-tab">
        <div class="mb-3">
          <label for="{{ form.token.id_for_label }}" class="form-label">
            <i class="bi bi-smartphone me-1"></i>
            Código do aplicativo autenticador
          </label>
          <input type="text"
                 class="form-control{% if form.token.errors %} is-invalid{% endif %}"
                 id="{{ form.token.id_for_label }}"
                 name="{{ form.token.name }}"
                 placeholder="Digite o código de 6 dígitos"
                 maxlength="6"
                 pattern="[0-9]{6}"
                 autocomplete="one-time-code"
                 required />
          {% if form.token.errors %}
            <div class="invalid-feedback">
              {% for error in form.token.errors %}{{ error }}{% endfor %}
            </div>
          {% endif %}
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            O código muda a cada 30 segundos
          </div>
        </div>
      </div>
      <!-- Tab do código de recuperação -->
      <div class="tab-pane fade"
           id="recovery"
           role="tabpanel"
           aria-labelledby="recovery-tab">
        <div class="mb-3">
          <label for="recovery_code" class="form-label">
            <i class="bi bi-key me-1"></i>
            Código de recuperação
          </label>
          <input type="text"
                 class="form-control"
                 id="recovery_code"
                 name="recovery_code"
                 placeholder="Digite um código de recuperação"
                 maxlength="20" />
          <div class="form-text">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Cada código de recuperação pode ser usado apenas uma vez
          </div>
        </div>
      </div>
    </div>
  {% endslot %}
  {% slot actions %}
  <button type="submit" class="btn btn-primary w-100">
    <i class="bi bi-check-circle me-2"></i>
    Verificar código
  </button>
{% endslot %}
{% endelement %}
<div class="mt-4 text-center">
  <div class="cl-divider">
    <span>Problemas para acessar?</span>
  </div>
  <div class="mt-3">
    <a href="{% url 'account_logout' %}" class="btn btn-outline-secondary">
      <i class="bi bi-box-arrow-right me-2"></i>
      Fazer logout
    </a>
  </div>
  <div class="mt-3">
    <small class="text-muted">
      <i class="bi bi-info-circle me-1"></i>
      Se você perdeu acesso ao seu dispositivo, entre em contato com o suporte
    </small>
  </div>
</div>
</div>
{% endblock content %}
{% block extra_css %}
  {{ block.super }}
  <style>
    .nav-tabs .nav-link {
      border: 1px solid #dee2e6;
      color: #6c757d;
    }

    .nav-tabs .nav-link.active {
      background-color: var(--cl-primary);
      border-color: var(--cl-primary);
      color: white;
    }

    .nav-tabs .nav-link:hover:not(.active) {
      border-color: var(--cl-primary);
      color: var(--cl-primary);
    }
  </style>
{% endblock extra_css %}
{% block javascript %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Alternar campos conforme a aba selecionada
      const totpTab = document.getElementById('totp-tab');
      const recoveryTab = document.getElementById('recovery-tab');
      const totpInput = document.querySelector('#totp input[name="token"]');
      const recoveryInput = document.querySelector('#recovery input[name="recovery_code"]');

      totpTab.addEventListener('click', function() {
        totpInput.required = true;
        recoveryInput.required = false;
        recoveryInput.value = '';
      });

      recoveryTab.addEventListener('click', function() {
        recoveryInput.required = true;
        totpInput.required = false;
        totpInput.value = '';
      });

      // Auto-focus no input ativo
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(function(tab) {
        tab.addEventListener('shown.bs.tab', function(e) {
          const targetPane = document.querySelector(e.target.getAttribute('data-bs-target'));
          const input = targetPane.querySelector('input');
          if (input) {
            input.focus();
          }
        });
      });

      // Focus inicial
      totpInput.focus();
    });
  </script>
{% endblock javascript %}
