{% extends "allauth/layouts/entrance.html" %}

{% load i18n %}
{% load allauth account %}

{% block head_title %}
  {% trans "Desativar Autenticação de Dois Fatores" %}
{% endblock head_title %}
{% block content %}
  <div class="card-header">
    <h2 class="card-title text-danger">
      <i class="bi bi-shield-exclamation me-2"></i>
      Desativar Autenticação de Dois Fatores
    </h2>
    <p class="card-description">Você está prestes a remover uma camada importante de segurança da sua conta.</p>
  </div>
  <div class="card-content">
    <div class="alert alert-danger border-0 mb-4" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>Atenção!</strong> Desativar a autenticação de dois fatores reduzirá significativamente a segurança da sua conta.
    </div>
    <div class="security-warning mb-4">
      <h5 class="text-danger mb-3">
        <i class="bi bi-shield-slash me-2"></i>
        Riscos de desativar o 2FA:
      </h5>
      <ul class="list-unstyled">
        <li class="mb-2 text-danger">
          <i class="bi bi-x-circle-fill me-2"></i>
          Sua conta ficará vulnerável se sua senha for comprometida
        </li>
        <li class="mb-2 text-danger">
          <i class="bi bi-x-circle-fill me-2"></i>
          Maior risco de acesso não autorizado a dados sensíveis
        </li>
        <li class="mb-2 text-danger">
          <i class="bi bi-x-circle-fill me-2"></i>
          Pode não atender aos requisitos de segurança da empresa
        </li>
        <li class="mb-2 text-danger">
          <i class="bi bi-x-circle-fill me-2"></i>
          Todos os códigos de recuperação serão invalidados
        </li>
      </ul>
    </div>
    {% url 'mfa_deactivate_totp' as action_url %}
    {% element form form=form method="post" action=action_url %}
    {% slot body %}
    {% csrf_token %}
    <div class="confirmation-section">
      <h6 class="mb-3">Confirme sua identidade para prosseguir:</h6>
      <div class="mb-3">
        <label for="{{ form.token.id_for_label }}" class="form-label">
          <i class="bi bi-key me-1"></i>
          Código do aplicativo autenticador ou código de recuperação
        </label>
        <input type="text"
               class="form-control{% if form.token.errors %} is-invalid{% endif %}"
               id="{{ form.token.id_for_label }}"
               name="{{ form.token.name }}"
               placeholder="Digite o código para confirmar"
               required />
        {% if form.token.errors %}
          <div class="invalid-feedback">
            {% for error in form.token.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="confirmDisable" required />
        <label class="form-check-label text-danger" for="confirmDisable">
          <strong>Eu entendo os riscos e quero desativar a autenticação de dois fatores</strong>
        </label>
      </div>
    </div>
  {% endslot %}
  {% slot actions %}
  <div class="d-grid gap-2">
    <button type="submit" class="btn btn-danger" id="disableBtn" disabled>
      <i class="bi bi-shield-slash me-2"></i>
      Confirmar Desativação
    </button>
    <a href="{% url 'mfa_index' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left me-2"></i>
      Cancelar e Voltar
    </a>
  </div>
{% endslot %}
{% endelement %}
<div class="mt-4">
  <div class="alert alert-info border-0" role="alert">
    <i class="bi bi-lightbulb me-2"></i>
    <strong>Sugestão:</strong> Se você está tendo problemas com o 2FA, considere gerar novos códigos de recuperação ao invés de desativá-lo completamente.
  </div>
</div>
</div>
{% endblock content %}
{% block extra_css %}
  {{ block.super }}
  <style>
    .security-warning ul li {
      padding: 5px 0;
    }

    .confirmation-section {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .form-check-label {
      font-weight: 500;
    }
  </style>
{% endblock extra_css %}
{% block javascript %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const checkbox = document.getElementById('confirmDisable');
      const submitBtn = document.getElementById('disableBtn');

      checkbox.addEventListener('change', function() {
        submitBtn.disabled = !this.checked;
      });

      // Confirmar antes de enviar
      submitBtn.addEventListener('click', function(e) {
        if (!confirm('ATENÇÃO: Você tem certeza que deseja desativar a autenticação de dois fatores? Esta ação reduzirá significativamente a segurança da sua conta.')) {
          e.preventDefault();
        }
      });
    });
  </script>
{% endblock javascript %}
