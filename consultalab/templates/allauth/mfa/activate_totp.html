{% extends "allauth/layouts/entrance.html" %}

{% load i18n %}
{% load allauth account %}

{% block head_title %}
  {% trans "Configurar Autenticação de Dois Fatores" %}
{% endblock head_title %}
{% block content %}
  <div class="card-header">
    <h2 class="card-title">
      <i class="bi bi-shield-lock me-2"></i>
      Configurar Autenticação de Dois Fatores
    </h2>
    <p class="card-description">
      Por questões de segurança, é obrigatório configurar a autenticação de dois fatores para acessar o sistema.
    </p>
  </div>
  <div class="card-content">
    {% if secret %}
      <div class="alert alert-info border-0" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Como configurar:</strong>
        <ol class="mb-0 mt-2">
          <li>Instale um aplicativo autenticador (Google Authenticator, Authy, etc.)</li>
          <li>Escaneie o código QR abaixo OU digite a chave manualmente</li>
          <li>Digite o código de 6 dígitos gerado pelo aplicativo</li>
        </ol>
      </div>
      <div class="text-center mb-4">
        <div class="qr-code-container">{{ qrcode|safe }}</div>
        <p class="mt-3 mb-2">
          <strong>Ou digite esta chave manualmente:</strong>
        </p>
        <div class="alert alert-light border">
          <code class="fs-6">{{ secret }}</code>
        </div>
      </div>
      {% url 'mfa_activate_totp' as action_url %}
      {% element form form=form method="post" action=action_url %}
      {% slot body %}
      {% csrf_token %}
      <div class="mb-3">
        <label for="{{ form.token.id_for_label }}" class="form-label">
          <i class="bi bi-key me-1"></i>
          Código do aplicativo autenticador
        </label>
        <input type="text"
               class="form-control{% if form.token.errors %} is-invalid{% endif %}"
               id="{{ form.token.id_for_label }}"
               name="{{ form.token.name }}"
               placeholder="Digite o código de 6 dígitos"
               maxlength="6"
               pattern="[0-9]{6}"
               autocomplete="one-time-code"
               required />
        {% if form.token.errors %}
          <div class="invalid-feedback">
            {% for error in form.token.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
      </div>
    {% endslot %}
    {% slot actions %}
    <button type="submit" class="btn btn-primary w-100">
      <i class="bi bi-check-circle me-2"></i>
      Ativar Autenticação de Dois Fatores
    </button>
  {% endslot %}
{% endelement %}
<div class="mt-4">
  <div class="alert alert-warning border-0" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Importante:</strong> Mantenha seu dispositivo seguro e considere fazer backup dos códigos de recuperação que serão gerados após a configuração.
  </div>
</div>
{% else %}
<div class="text-center">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Carregando...</span>
  </div>
  <p class="mt-3">Gerando código QR...</p>
</div>
{% endif %}
</div>
{% endblock content %}
{% block extra_css %}
  {{ block.super }}
  <style>
    .qr-code-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      display: inline-block;
    }

    .qr-code-container img {
      max-width: 200px;
      height: auto;
    }

    code {
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }
  </style>
{% endblock extra_css %}
