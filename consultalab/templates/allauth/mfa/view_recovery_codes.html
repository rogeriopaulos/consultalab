{% extends "allauth/layouts/entrance.html" %}

{% load i18n %}
{% load allauth account %}

{% block head_title %}
  {% trans "Visualizar Códigos de Recuperação" %}
{% endblock head_title %}
{% block content %}
  <div class="card-header">
    <h2 class="card-title">
      <i class="bi bi-key me-2"></i>
      Códigos de Recuperação
    </h2>
    <p class="card-description">Seus códigos de backup para emergências. Guarde-os em local seguro.</p>
  </div>
  <div class="card-content">
    <div class="alert alert-warning border-0 mb-4" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>Importante:</strong> Cada código pode ser usado apenas uma vez. Se você usar todos, gere novos códigos.
    </div>
    {% if recovery_codes %}
      <div class="recovery-codes-container">
        <h5 class="mb-3">
          <i class="bi bi-key me-1"></i>
          Seus códigos de recuperação:
        </h5>
        <div class="codes-grid">
          {% for code in recovery_codes %}
            <div class="code-item {% if code.is_used %}used{% endif %}">
              <code>{{ code.code }}</code>
              {% if code.is_used %}<small class="text-muted d-block">Usado</small>{% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="action-buttons mt-4">
        <button type="button"
                class="btn btn-outline-primary me-2"
                onclick="downloadCodes()">
          <i class="bi bi-download me-2"></i>
          Baixar códigos
        </button>
        <button type="button"
                class="btn btn-outline-secondary me-2"
                onclick="printCodes()">
          <i class="bi bi-printer me-2"></i>
          Imprimir códigos
        </button>
        <button type="button" class="btn btn-outline-info" onclick="copyCodes()">
          <i class="bi bi-clipboard me-2"></i>
          Copiar disponíveis
        </button>
      </div>
      <div class="mt-4">
        <a href="{% url 'mfa_generate_recovery_codes' %}"
           class="btn btn-warning w-100">
          <i class="bi bi-arrow-clockwise me-2"></i>
          Gerar Novos Códigos de Recuperação
        </a>
        <div class="form-text text-center mt-2">
          <small class="text-muted">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Atenção: Gerar novos códigos invalidará todos os códigos atuais
          </small>
        </div>
      </div>
    {% else %}
      <div class="text-center">
        <div class="mb-4">
          <i class="bi bi-key display-1 text-muted"></i>
        </div>
        <h5 class="mb-3">Nenhum código de recuperação encontrado</h5>
        <p class="text-muted mb-4">Gere códigos de recuperação para ter acesso de emergência à sua conta.</p>
        <a href="{% url 'mfa_generate_recovery_codes' %}"
           class="btn btn-primary btn-lg">
          <i class="bi bi-plus-circle me-2"></i>
          Gerar Códigos de Recuperação
        </a>
      </div>
    {% endif %}
    <div class="mt-4">
      <div class="alert alert-info border-0" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        Use os códigos de recuperação apenas se você perder acesso ao seu aplicativo autenticador.
      </div>
    </div>
    <div class="text-center mt-4">
      <a href="{% url 'mfa_index' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-2"></i>
        Voltar para configurações MFA
      </a>
    </div>
  </div>
{% endblock content %}
{% block extra_css %}
  {{ block.super }}
  <style>
    .recovery-codes-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
    }

    .codes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .code-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 12px;
      text-align: center;
      transition: all 0.2s;
    }

    .code-item.used {
      background: #f5f5f5;
      border-color: #ccc;
      opacity: 0.6;
    }

    .code-item.used code {
      text-decoration: line-through;
      color: #999;
    }

    .code-item:not(.used):hover {
      border-color: var(--cl-primary);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .code-item code {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
      display: block;
    }

    @media print {

      .action-buttons,
      .alert,
      .btn {
        display: none !important;
      }
    }
  </style>
{% endblock extra_css %}
{% block javascript %}
  {{ block.super }}
  <script>
    function downloadCodes() {
      const codes = [];
      document.querySelectorAll('.code-item:not(.used) code').forEach(el => {
        codes.push(el.textContent.trim());
      });

      if (codes.length === 0) {
        alert('Não há códigos disponíveis para download.');
        return;
      }

      const content = 'Códigos de Recuperação - ConsultaLab\n' +
        'Gerado em: ' + new Date().toLocaleString() + '\n\n' +
        codes.join('\n') +
        '\n\nIMPORTANTE: Cada código pode ser usado apenas uma vez. Guarde em local seguro!';

      const blob = new Blob([content], {
        type: 'text/plain'
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'consultalab-recovery-codes-' + new Date().getTime() + '.txt';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function printCodes() {
      window.print();
    }

    function copyCodes() {
      const codes = [];
      document.querySelectorAll('.code-item:not(.used) code').forEach(el => {
        codes.push(el.textContent.trim());
      });

      if (codes.length === 0) {
        alert('Não há códigos disponíveis para copiar.');
        return;
      }

      const text = codes.join('\n');

      navigator.clipboard.writeText(text).then(() => {
        // Mostrar feedback visual
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-2"></i>Copiado!';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-success');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-info');
        }, 2000);
      }).catch(() => {
        alert('Erro ao copiar. Selecione e copie manualmente.');
      });
    }
  </script>
{% endblock javascript %}
