{% extends "allauth/layouts/entrance.html" %}

{% load i18n %}
{% load allauth account %}

{% block head_title %}
  {% trans "Códigos de Recuperação" %}
{% endblock head_title %}
{% block content %}
  <div class="card-header">
    <h2 class="card-title">
      <i class="bi bi-shield-check me-2 text-success"></i>
      2FA Ativado com Sucesso!
    </h2>
    <p class="card-description">
      Guarde estes códigos de recuperação em local seguro. Você precisará deles se perder acesso ao seu dispositivo.
    </p>
  </div>
  <div class="card-content">
    <div class="alert alert-warning border-0 mb-4" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong>Importante:</strong> Cada código pode ser usado apenas uma vez. Guarde-os em local seguro!
    </div>
    <div class="recovery-codes-container">
      <h5 class="mb-3">
        <i class="bi bi-key me-1"></i>
        Seus códigos de recuperação:
      </h5>
      <div class="codes-grid">
        {% for code in recovery_codes %}
          <div class="code-item">
            <code>{{ code }}</code>
          </div>
        {% endfor %}
      </div>
    </div>
    <div class="action-buttons mt-4">
      <button type="button"
              class="btn btn-outline-primary me-2"
              onclick="downloadCodes()">
        <i class="bi bi-download me-2"></i>
        Baixar códigos
      </button>
      <button type="button"
              class="btn btn-outline-secondary me-2"
              onclick="printCodes()">
        <i class="bi bi-printer me-2"></i>
        Imprimir códigos
      </button>
      <button type="button" class="btn btn-outline-info" onclick="copyCodes()">
        <i class="bi bi-clipboard me-2"></i>
        Copiar todos
      </button>
    </div>
    <div class="mt-4">
      {% if request.GET.next %}
        <a href="{{ request.GET.next }}" class="btn btn-primary w-100">
          <i class="bi bi-arrow-right me-2"></i>
          Continuar para o sistema
        </a>
      {% else %}
        <a href="{% url 'core:home' %}" class="btn btn-primary w-100">
          <i class="bi bi-house me-2"></i>
          Ir para a página inicial
        </a>
      {% endif %}
    </div>
    <div class="mt-3">
      <div class="alert alert-info border-0" role="alert">
        <i class="bi bi-info-circle me-2"></i>
        Você pode gerar novos códigos de recuperação a qualquer momento nas configurações da sua conta.
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_css %}
  {{ block.super }}
  <style>
    .recovery-codes-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
    }

    .codes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .code-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 8px 12px;
      text-align: center;
    }

    .code-item code {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
    }

    @media print {

      .action-buttons,
      .alert {
        display: none !important;
      }
    }
  </style>
{% endblock extra_css %}
{% block javascript %}
  {{ block.super }}
  <script>
    function downloadCodes() {
      const codes = [{
          %
          for code in recovery_codes %
        }
        '{{ code }}' {
          %
          if not forloop.last %
        }, {
          %
          endif %
        } {
          %
          endfor %
        }
      ];
      const content = 'Códigos de Recuperação - ConsultaLab\n' +
        'Gerado em: ' + new Date().toLocaleString() + '\n\n' +
        codes.join('\n') +
        '\n\nIMPORTANTE: Cada código pode ser usado apenas uma vez. Guarde em local seguro!';

      const blob = new Blob([content], {
        type: 'text/plain'
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'consultalab-recovery-codes.txt';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function printCodes() {
      window.print();
    }

    function copyCodes() {
      const codes = [{
          %
          for code in recovery_codes %
        }
        '{{ code }}' {
          %
          if not forloop.last %
        }, {
          %
          endif %
        } {
          %
          endfor %
        }
      ];
      const text = codes.join('\n');

      navigator.clipboard.writeText(text).then(() => {
        // Mostrar feedback visual
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-2"></i>Copiado!';
        btn.classList.remove('btn-outline-info');
        btn.classList.add('btn-success');

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-info');
        }, 2000);
      }).catch(() => {
        alert('Erro ao copiar. Selecione e copie manualmente.');
      });
    }
  </script>
{% endblock javascript %}
